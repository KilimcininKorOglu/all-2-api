version: '3.8'

# Cluster mode with bridge network
# Usage: docker-compose -f docker-compose.cluster.yml up -d

x-api-common: &api-common
  build: .
  restart: unless-stopped
  environment: &api-env
    TZ: ${TZ:-UTC}
    MYSQL_HOST: ${MYSQL_HOST:-host.docker.internal}
    MYSQL_PORT: ${MYSQL_PORT:-13306}
    MYSQL_USER: ${MYSQL_USER:-root}
    MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    MYSQL_DATABASE: ${MYSQL_DATABASE:-kiro_api}
  extra_hosts:
    - "host.docker.internal:host-gateway"
  networks:
    - kiro-network

services:
  balancer:
    build: .
    container_name: kiro-balancer
    restart: unless-stopped
    ports:
      - "${BALANCER_PORT:-13003}:13003"
    environment:
      - TZ=${TZ:-UTC}
      - BALANCER_PORT=13003
      - BACKEND_HOSTS=api-1:13004,api-2:13005,api-3:13006,api-4:13007,api-5:13008
    command: ["node", "src/cluster/balancer.js"]
    depends_on:
      - api-1
      - api-2
      - api-3
      - api-4
      - api-5
    networks:
      - kiro-network

  api-1:
    <<: *api-common
    container_name: kiro-api-1
    environment:
      <<: *api-env
      PORT: 13004

  api-2:
    <<: *api-common
    container_name: kiro-api-2
    environment:
      <<: *api-env
      PORT: 13005

  api-3:
    <<: *api-common
    container_name: kiro-api-3
    environment:
      <<: *api-env
      PORT: 13006

  api-4:
    <<: *api-common
    container_name: kiro-api-4
    environment:
      <<: *api-env
      PORT: 13007

  api-5:
    <<: *api-common
    container_name: kiro-api-5
    environment:
      <<: *api-env
      PORT: 13008

networks:
  kiro-network:
    driver: bridge

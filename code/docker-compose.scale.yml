
# Dynamic scaling version - External database + Host network mode
# Usage:
#   Start: docker-compose -f docker-compose.scale.yml up -d
#   Scale: Modify the number of API instances below and run up again
#
# Environment variable configuration (can be set in .env file):
#   BALANCER_PORT  - Load balancer port (default: 13003)
#   MYSQL_HOST     - MySQL host address (default: 127.0.0.1)
#   MYSQL_PORT     - MySQL port (default: 3306)
#   MYSQL_USER     - MySQL username (default: root)
#   MYSQL_PASSWORD - MySQL password (required)
#   MYSQL_DATABASE - Database name (default: kiro_api)

x-api-common: &api-common
  build: .
  restart: unless-stopped
  network_mode: host
  environment: &api-env
    TZ: ${TZ:-UTC}
    MYSQL_HOST: ${MYSQL_HOST:-127.0.0.1}
    MYSQL_PORT: ${MYSQL_PORT:-3306}
    MYSQL_USER: ${MYSQL_USER:-root}
    MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    MYSQL_DATABASE: ${MYSQL_DATABASE:-kiro_api}

services:
  balancer:
    build: .
    container_name: kiro-balancer
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ:-UTC}
      - BALANCER_PORT=${BALANCER_PORT:-13003}
      - BACKEND_PORTS=13004,13005,13006,13007,13008
    command: ["node", "src/cluster/balancer.js"]

  api-1:
    <<: *api-common
    container_name: kiro-api-1
    environment:
      <<: *api-env
      PORT: 13004

  api-2:
    <<: *api-common
    container_name: kiro-api-2
    environment:
      <<: *api-env
      PORT: 13005

  api-3:
    <<: *api-common
    container_name: kiro-api-3
    environment:
      <<: *api-env
      PORT: 13006

  api-4:
    <<: *api-common
    container_name: kiro-api-4
    environment:
      <<: *api-env
      PORT: 13007

  api-5:
    <<: *api-common
    container_name: kiro-api-5
    environment:
      <<: *api-env
      PORT: 13008
